name: Pull GAS Code

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Select environment to pull code from'
        required: true
        type: choice
        options:
          - deployment
          - staging
          - production
          - custom
      script_id:
        description: 'Script ID (required if environment is "custom")'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  pull:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Determine Secret Environment Prefix
        id: secret-env
        env:
          ENVIRONMENT: ${{ inputs.environment }}
        run: |
          case $ENVIRONMENT in
            deployment)
              PREFIX="DEV_"
              ;;
            staging)
              PREFIX="STAGING_"
              ;;
            production)
              PREFIX="PROD_"
              ;;
            *)
              PREFIX=""
              ;;
          esac
          echo "prefix=$PREFIX" >> $GITHUB_OUTPUT

      - uses: actions/checkout@v4

      - name: Clasp Init
        uses: ./.github/actions/clasp_init

      - name: Set up authentication
        uses: ./.github/actions/create_clasprc
        with:
          access_token: ${{ secrets[format('{0}ACCESS_TOKEN', steps.secret-env.outputs.prefix)] || secrets.ACCESS_TOKEN }}
          id_token: ${{ secrets[format('{0}ID_TOKEN', steps.secret-env.outputs.prefix)] || secrets.ID_TOKEN }}
          refresh_token: ${{ secrets[format('{0}REFRESH_TOKEN', steps.secret-env.outputs.prefix)] || secrets.REFRESH_TOKEN }}
          client_id: ${{ secrets[format('{0}CLIENT_ID', steps.secret-env.outputs.prefix)] || secrets.CLIENT_ID }}
          client_secret: ${{ secrets[format('{0}CLIENT_SECRET', steps.secret-env.outputs.prefix)] || secrets.CLIENT_SECRET }}

      - name: Generate .clasp.json
        env:
          PREFIX: ${{ steps.secret-env.outputs.prefix }}
          INPUT_SCRIPT_ID: ${{ inputs.script_id }}
          SECRET_SCRIPT_ID: ${{ secrets[format('{0}SCRIPT_ID', steps.secret-env.outputs.prefix)] || secrets.SCRIPT_ID }}
        run: |
          # Use input script_id if provided (custom), otherwise use secret
          if [ -n "$INPUT_SCRIPT_ID" ]; then
            SCRIPT_ID="$INPUT_SCRIPT_ID"
          else
            SCRIPT_ID="$SECRET_SCRIPT_ID"
          fi

          echo '{
            "scriptId": "'$SCRIPT_ID'",
            "rootDir": "./src"
          }' | jq '.' > .clasp.json

      - name: Pull GAS Code
        run: |
          mkdir -p ./src
          clasp pull
          echo "Pulled files:"
          ls -la ./src

      - name: Create PR
        uses: ./.github/actions/create_pr
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          environment: ${{ inputs.environment }}
